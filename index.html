<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üî• FireGuard - Monitoring Stra≈ºaka</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --fire-orange: #ff6b35;
            --fire-red: #e63946;
            --fire-yellow: #ffd166;
            --dark-bg: #0a0a0f;
            --card-bg: rgba(26, 15, 15, 0.85);
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --danger: #dc3545;
            --warning: #ffc107;
            --safe: #28a745;
            --info: #17a2b8;
            --glow-orange: 0 0 20px rgba(255, 107, 53, 0.5);
            --glow-red: 0 0 30px rgba(230, 57, 70, 0.7);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .fire-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 50% 100%, rgba(255, 107, 53, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 20% 80%, rgba(230, 57, 70, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 90%, rgba(255, 209, 102, 0.1) 0%, transparent 40%),
                linear-gradient(180deg, #0a0a0f 0%, #1a0a0a 100%);
            animation: firePulse 4s ease-in-out infinite;
        }

        @keyframes firePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .header {
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, rgba(255, 107, 53, 0.2) 0%, transparent 100%);
            border-bottom: 2px solid var(--fire-orange);
        }

        .header h1 {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--fire-yellow), var(--fire-orange), var(--fire-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }

        .header .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
            letter-spacing: 2px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--card-bg);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--safe);
            animation: pulse 2s infinite;
        }

        .status-indicator.danger {
            background: var(--danger);
            animation: dangerPulse 0.5s infinite;
        }

        .status-indicator.warning {
            background: var(--warning);
        }

        .status-indicator.indoor {
            background: var(--info);
            animation: indoorPulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        }

        @keyframes dangerPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.9); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(220, 53, 69, 0); transform: scale(1.2); }
        }

        @keyframes indoorPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(23, 162, 184, 0); }
        }

        .status-text {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            letter-spacing: 2px;
        }

        .container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .mode-toggle {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--fire-orange), var(--fire-red));
            color: white;
        }

        .mode-btn.indoor-active {
            background: linear-gradient(135deg, var(--info), #138496);
            color: white;
        }

        .sensor-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--fire-orange), var(--fire-yellow), var(--fire-orange));
        }

        .sensor-card.indoor-card::before {
            background: linear-gradient(90deg, var(--info), #20c997, var(--info));
        }

        .sensor-card.alert {
            border-color: var(--danger);
            box-shadow: var(--glow-red);
            animation: alertShake 0.5s ease-in-out;
        }

        @keyframes alertShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .sensor-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sensor-icon {
            font-size: 1.5rem;
        }

        .sensor-title {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--fire-orange);
        }

        .sensor-card.indoor-card .sensor-title {
            color: var(--info);
        }

        .sensor-data {
            display: grid;
            gap: 10px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid var(--fire-orange);
        }

        .indoor-card .data-row {
            border-left-color: var(--info);
        }

        .data-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .data-value {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--fire-yellow);
        }

        /* Indoor positioning visualization */
        .indoor-map {
            position: relative;
            height: 200px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 2px solid rgba(23, 162, 184, 0.3);
        }

        .indoor-map-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(23, 162, 184, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(23, 162, 184, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .entry-point {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--safe);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.7);
        }

        .entry-point::after {
            content: 'üö™';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2rem;
        }

        .current-position {
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--fire-orange);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.8);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .current-position::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid var(--fire-orange);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: positionPulse 2s infinite;
        }

        .current-position::after {
            content: 'üßë‚Äçüöí';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
        }

        @keyframes positionPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        .direction-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 20px solid var(--fire-yellow);
            transform-origin: center bottom;
            z-index: 11;
        }

        .path-trail {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 107, 53, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .compass-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
        }

        .compass {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid var(--info);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compass-directions {
            position: absolute;
            width: 100%;
            height: 100%;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .compass-directions span {
            position: absolute;
            transform: translate(-50%, -50%);
        }

        .compass-directions .n { top: 10%; left: 50%; color: var(--danger); }
        .compass-directions .s { bottom: 5%; left: 50%; }
        .compass-directions .e { top: 50%; right: 5%; }
        .compass-directions .w { top: 50%; left: 10%; }

        .compass-needle {
            width: 6px;
            height: 80px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center center;
            transition: transform 0.15s ease-out;
        }

        .compass-needle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 35px solid var(--danger);
        }

        .compass-needle::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 30px solid var(--info);
        }

        .compass-center {
            width: 14px;
            height: 14px;
            background: radial-gradient(circle, #fff 30%, var(--fire-orange) 100%);
            border-radius: 50%;
            position: absolute;
            z-index: 15;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Floor indicator */
        .floor-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .floor-visual {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .floor-level {
            width: 80px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .floor-level.current {
            background: var(--fire-orange);
            color: white;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
        }

        .fall-detector {
            position: relative;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .person-icon {
            font-size: 4rem;
            transition: transform 0.3s ease;
        }

        .person-icon.falling {
            animation: fallAnimation 1s ease-in-out;
        }

        @keyframes fallAnimation {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg) translateX(30px); }
            100% { transform: rotate(0deg); }
        }

        .g-force-meter {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .g-force-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--safe), var(--warning), var(--danger));
            transition: width 0.1s ease;
            border-radius: 4px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-start {
            background: linear-gradient(135deg, var(--fire-orange), var(--fire-red));
            color: white;
            grid-column: span 2;
            box-shadow: var(--glow-orange);
        }

        .btn-start:hover {
            transform: translateY(-2px);
        }

        .btn-start.active {
            background: linear-gradient(135deg, var(--safe), #20c997);
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
        }

        .btn-indoor {
            background: linear-gradient(135deg, var(--info), #138496);
            color: white;
            grid-column: span 2;
        }

        .btn-sos {
            background: var(--danger);
            color: white;
            animation: sosPulse 2s infinite;
        }

        @keyframes sosPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3); }
        }

        .btn-reset {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .alert-modal.show {
            display: flex;
        }

        .alert-content {
            background: linear-gradient(135deg, var(--danger), #b02a37);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            animation: alertBounce 0.5s ease;
        }

        @keyframes alertBounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .alert-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .alert-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .alert-text {
            font-size: 1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .alert-countdown {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 20px;
        }

        .btn-cancel-alert {
            background: white;
            color: var(--danger);
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
        }

        .log-section {
            background: var(--card-bg);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: var(--fire-orange);
            margin-bottom: 10px;
        }

        .log-entry {
            font-size: 0.75rem;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 5px;
            border-left: 2px solid var(--fire-orange);
        }

        .log-entry.danger {
            border-left-color: var(--danger);
            background: rgba(220, 53, 69, 0.2);
        }

        .log-entry.info {
            border-left-color: var(--info);
            background: rgba(23, 162, 184, 0.2);
        }

        .log-time {
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .permissions-section {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--warning);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .permissions-section h3 {
            color: var(--warning);
            margin-bottom: 10px;
        }

        .permission-list {
            text-align: left;
            margin: 15px 0;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .permission-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .permission-status.granted { background: var(--safe); }
        .permission-status.denied { background: var(--danger); }
        .permission-status.pending { background: var(--warning); }

        .https-warning {
            background: linear-gradient(135deg, var(--danger), #b02a37);
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            margin: 20px;
        }

        .info-box {
            background: rgba(23, 162, 184, 0.1);
            border: 1px solid var(--info);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-box h4 {
            color: var(--info);
            margin-bottom: 10px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
        }

        .info-box p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        @media (max-width: 380px) {
            .header h1 { font-size: 1.4rem; }
            .sensor-title { font-size: 0.85rem; }
            .data-value { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="fire-bg"></div>

    <header class="header">
        <h1>üî• FIREGUARD</h1>
        <div class="subtitle">System Monitoringu Stra≈ºaka</div>
    </header>

    <div class="status-bar">
        <div class="status-indicator" id="statusIndicator"></div>
        <span class="status-text" id="statusText">OCZEKIWANIE</span>
    </div>

    <div class="container">
        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button class="mode-btn active" id="modeOutdoor" onclick="setMode('outdoor')">
                üõ∞Ô∏è GPS OUTDOOR
            </button>
            <button class="mode-btn" id="modeIndoor" onclick="setMode('indoor')">
                üè¢ PDR INDOOR
            </button>
        </div>

        <!-- Info Box for Indoor Mode -->
        <div class="info-box" id="indoorInfo" style="display: none;">
            <h4>üìç Pozycjonowanie wewnƒôtrzne (PDR)</h4>
            <p>Gdy GPS nie dzia≈Ça, u≈ºywamy:<br>
            ‚Ä¢ <strong>Krokomierz</strong> - liczenie krok√≥w<br>
            ‚Ä¢ <strong>Kompas</strong> - kierunek ruchu<br>
            ‚Ä¢ <strong>Barometr</strong> - wykrywanie piƒôtra<br>
            ‚Ä¢ <strong>≈ªyroskop</strong> - obroty cia≈Ça</p>
        </div>

        <!-- Permissions Section -->
        <div class="permissions-section" id="permissionsSection">
            <h3>üì± Uprawnienia Czujnik√≥w</h3>
            <p>Do dzia≈Çania systemu wymagany jest dostƒôp do czujnik√≥w telefonu</p>
            <div class="permission-list">
                <div class="permission-item">
                    <div class="permission-status pending" id="gpsStatus">?</div>
                    <span>GPS / Geolokalizacja</span>
                </div>
                <div class="permission-item">
                    <div class="permission-status pending" id="motionStatus">?</div>
                    <span>Akcelerometr / ≈ªyroskop</span>
                </div>
                <div class="permission-item">
                    <div class="permission-status pending" id="compassStatus">?</div>
                    <span>Kompas / Magnetometr</span>
                </div>
            </div>
            <button class="btn btn-start" onclick="requestPermissions()">
                üöÄ POPRO≈ö O UPRAWNIENIA
            </button>
        </div>

        <!-- OUTDOOR MODE CARDS -->
        <div id="outdoorCards">
            <!-- GPS Card -->
            <div class="sensor-card" id="gpsCard">
                <div class="sensor-header">
                    <span class="sensor-icon">üìç</span>
                    <span class="sensor-title">POZYCJA GPS</span>
                </div>
                <div class="sensor-data">
                    <div class="data-row">
                        <span class="data-label">Szeroko≈õƒá</span>
                        <span class="data-value" id="latitude">---.------</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">D≈Çugo≈õƒá</span>
                        <span class="data-value" id="longitude">---.------</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Dok≈Çadno≈õƒá</span>
                        <span class="data-value" id="accuracy">--- m</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Prƒôdko≈õƒá</span>
                        <span class="data-value" id="speed">--- km/h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- INDOOR MODE CARDS -->
        <div id="indoorCards" style="display: none;">
            <!-- Indoor Map Visualization -->
            <div class="sensor-card indoor-card">
                <div class="sensor-header">
                    <span class="sensor-icon">üó∫Ô∏è</span>
                    <span class="sensor-title">MAPA WEWNƒòTRZNA (PDR)</span>
                </div>
                <div class="indoor-map" id="indoorMap">
                    <div class="indoor-map-grid"></div>
                    <div class="entry-point" id="entryPoint" style="left: 50%; top: 90%;"></div>
                    <div class="current-position" id="currentPosition" style="left: 50%; top: 90%;"></div>
                    <div class="direction-arrow" id="directionArrow" style="left: 50%; top: 85%;"></div>
                </div>
                <div class="sensor-data">
                    <div class="data-row">
                        <span class="data-label">Od wej≈õcia</span>
                        <span class="data-value" id="distanceFromEntry">0.0 m</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Kierunek</span>
                        <span class="data-value" id="currentDirection">N 0¬∞</span>
                    </div>
                </div>
            </div>

            <!-- Compass Card -->
            <div class="sensor-card indoor-card">
                <div class="sensor-header">
                    <span class="sensor-icon">üß≠</span>
                    <span class="sensor-title">KOMPAS / KIERUNEK</span>
                </div>
                <div class="compass-container">
                    <div class="compass">
                        <div class="compass-directions">
                            <span class="n">N</span>
                            <span class="s">S</span>
                            <span class="e">E</span>
                            <span class="w">W</span>
                        </div>
                        <div class="compass-needle" id="compassNeedle"></div>
                        <div class="compass-center"></div>
                    </div>
                </div>
                <div class="sensor-data">
                    <div class="data-row">
                        <span class="data-label">Azymut</span>
                        <span class="data-value" id="heading">0¬∞</span>
                    </div>
                </div>
            </div>

            <!-- Pedometer Card -->
            <div class="sensor-card indoor-card">
                <div class="sensor-header">
                    <span class="sensor-icon">üö∂</span>
                    <span class="sensor-title">KROKOMIERZ</span>
                </div>
                <div class="sensor-data">
                    <div class="data-row">
                        <span class="data-label">Kroki</span>
                        <span class="data-value" id="stepCount">0</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Dystans</span>
                        <span class="data-value" id="walkDistance">0.0 m</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Tempo</span>
                        <span class="data-value" id="stepRate">0 kr/min</span>
                    </div>
                </div>
            </div>

            <!-- Floor Detection Card -->
            <div class="sensor-card indoor-card">
                <div class="sensor-header">
                    <span class="sensor-icon">üè¢</span>
                    <span class="sensor-title">WYKRYWANIE PIƒòTRA</span>
                </div>
                <div class="floor-indicator">
                    <div class="floor-visual" id="floorVisual">
                        <div class="floor-level" data-floor="3">P3</div>
                        <div class="floor-level" data-floor="2">P2</div>
                        <div class="floor-level" data-floor="1">P1</div>
                        <div class="floor-level current" data-floor="0">P0</div>
                        <div class="floor-level" data-floor="-1">-1</div>
                    </div>
                </div>
                <div class="sensor-data">
                    <div class="data-row">
                        <span class="data-label">Aktualne piƒôtro</span>
                        <span class="data-value" id="currentFloor">P0</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Ci≈õnienie</span>
                        <span class="data-value" id="pressure">--- hPa</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Œî Wysoko≈õƒá</span>
                        <span class="data-value" id="altitudeChange">0.0 m</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accelerometer Card (Both modes) -->
        <div class="sensor-card" id="accelCard">
            <div class="sensor-header">
                <span class="sensor-icon">üìä</span>
                <span class="sensor-title">AKCELEROMETR</span>
            </div>
            <div class="sensor-data">
                <div class="data-row">
                    <span class="data-label">X</span>
                    <span class="data-value" id="accelX">0.00 m/s¬≤</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Y</span>
                    <span class="data-value" id="accelY">0.00 m/s¬≤</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Z</span>
                    <span class="data-value" id="accelZ">0.00 m/s¬≤</span>
                </div>
                <div class="data-row">
                    <span class="data-label">G-Force</span>
                    <span class="data-value" id="gForce">1.00 G</span>
                </div>
            </div>
        </div>

        <!-- Fall Detection Card -->
        <div class="sensor-card" id="fallCard">
            <div class="sensor-header">
                <span class="sensor-icon">üö®</span>
                <span class="sensor-title">WYKRYWANIE UPADKU</span>
            </div>
            <div class="fall-detector">
                <div class="person-icon" id="personIcon">üßë‚Äçüöí</div>
                <div class="g-force-meter">
                    <div class="g-force-bar" id="gForceBar" style="width: 10%"></div>
                </div>
            </div>
            <div class="sensor-data">
                <div class="data-row">
                    <span class="data-label">Pr√≥g upadku</span>
                    <span class="data-value">2.5 G</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Status</span>
                    <span class="data-value" id="fallStatus">NORMA ‚úì</span>
                </div>
            </div>
        </div>

        <!-- Gyroscope Card -->
        <div class="sensor-card" id="gyroCard">
            <div class="sensor-header">
                <span class="sensor-icon">üîÑ</span>
                <span class="sensor-title">≈ªYROSKOP / ORIENTACJA</span>
            </div>
            <div class="sensor-data">
                <div class="data-row">
                    <span class="data-label">Alpha (Z)</span>
                    <span class="data-value" id="alpha">0¬∞</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Beta (X)</span>
                    <span class="data-value" id="beta">0¬∞</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Gamma (Y)</span>
                    <span class="data-value" id="gamma">0¬∞</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-start" id="btnStart" onclick="toggleMonitoring()">
                ‚ñ∂ START MONITORINGU
            </button>
            <button class="btn btn-indoor" id="btnIndoor" onclick="markEntryPoint()" style="display: none;">
                üö™ ZAZNACZ WEJ≈öCIE
            </button>
            <button class="btn btn-sos" onclick="triggerSOS()">
                üÜò SOS
            </button>
            <button class="btn btn-reset" onclick="resetAlerts()">
                üîÑ RESETUJ
            </button>
        </div>

        <!-- Event Log -->
        <div class="log-section">
            <div class="log-title">üìã DZIENNIK ZDARZE≈É</div>
            <div id="logContainer">
                <div class="log-entry">
                    <span class="log-time">--:--:--</span>
                    System gotowy do uruchomienia
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-modal" id="alertModal">
        <div class="alert-content">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-title">WYKRYTO UPADEK!</div>
            <div class="alert-text">Automatyczne wezwanie pomocy za:</div>
            <div class="alert-countdown" id="alertCountdown">10</div>
            <button class="btn-cancel-alert" onclick="cancelAlert()">
                ‚ùå WSZYSTKO W PORZƒÑDKU
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // FireGuard - System Monitoringu Stra≈ºaka
        // z Pozycjonowaniem Wewnƒôtrznym (PDR)
        // ============================================

        // Mode
        let currentMode = 'outdoor'; // 'outdoor' or 'indoor'

        // State
        let isMonitoring = false;
        let watchId = null;
        let alertCountdown = 10;
        let countdownInterval = null;
        let lastPosition = null;
        let fallThreshold = 2.5;
        let impactCooldown = false;

        // PDR (Pedestrian Dead Reckoning) State
        let pdrState = {
            entryPoint: null,           // GPS position when entering building
            currentHeading: 0,          // Compass heading in degrees
            stepCount: 0,               // Total steps
            stepLength: 0.7,            // Average step length in meters
            lastStepTime: 0,            // For step rate calculation
            stepTimes: [],              // Array of step timestamps
            positionX: 0,               // Relative X position (meters)
            positionY: 0,               // Relative Y position (meters)
            basePressure: null,         // Reference pressure at entry
            currentFloor: 0,            // Detected floor
            pathTrail: [],              // Array of past positions for visualization
            lastAccelMagnitude: 0,      // For step detection
            stepThreshold: 12,          // Acceleration threshold for step detection
            stepCooldown: false         // Prevent double counting
        };

        // DOM Elements
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const btnStart = document.getElementById('btnStart');
        const alertModal = document.getElementById('alertModal');
        const logContainer = document.getElementById('logContainer');
        const permissionsSection = document.getElementById('permissionsSection');

        // Mode elements
        const outdoorCards = document.getElementById('outdoorCards');
        const indoorCards = document.getElementById('indoorCards');
        const indoorInfo = document.getElementById('indoorInfo');
        const btnIndoor = document.getElementById('btnIndoor');
        const modeOutdoor = document.getElementById('modeOutdoor');
        const modeIndoor = document.getElementById('modeIndoor');

        // Set mode
        function setMode(mode) {
            currentMode = mode;
            
            if (mode === 'outdoor') {
                modeOutdoor.classList.add('active');
                modeOutdoor.classList.remove('indoor-active');
                modeIndoor.classList.remove('active', 'indoor-active');
                outdoorCards.style.display = 'block';
                indoorCards.style.display = 'none';
                indoorInfo.style.display = 'none';
                btnIndoor.style.display = 'none';
                statusIndicator.classList.remove('indoor');
                addLog('üõ∞Ô∏è Tryb GPS OUTDOOR aktywny');
            } else {
                modeIndoor.classList.add('indoor-active');
                modeOutdoor.classList.remove('active');
                outdoorCards.style.display = 'none';
                indoorCards.style.display = 'block';
                indoorInfo.style.display = 'block';
                btnIndoor.style.display = 'block';
                statusIndicator.classList.add('indoor');
                addLog('üè¢ Tryb PDR INDOOR aktywny', false, 'info');
            }
        }

        // Request permissions
        async function requestPermissions() {
            addLog('üì± ≈ªƒÖdanie uprawnie≈Ñ...');
            const gpsStatusEl = document.getElementById('gpsStatus');
            const motionStatusEl = document.getElementById('motionStatus');
            const compassStatusEl = document.getElementById('compassStatus');

            // GPS
            try {
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });
                gpsStatusEl.textContent = '‚úì';
                gpsStatusEl.classList.add('granted');
                gpsStatusEl.classList.remove('pending', 'denied');
                addLog('‚úÖ Uzyskano uprawnienie GPS');
            } catch (err) {
                gpsStatusEl.textContent = '‚úó';
                gpsStatusEl.classList.add('denied');
                gpsStatusEl.classList.remove('pending', 'granted');
                addLog('‚ùå GPS: ' + err.message, true);
            }

            // Motion
            if (typeof DeviceMotionEvent !== 'undefined') {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const state = await DeviceMotionEvent.requestPermission();
                        if (state === 'granted') {
                            motionStatusEl.textContent = '‚úì';
                            motionStatusEl.classList.add('granted');
                            addLog('‚úÖ Uzyskano uprawnienie ruchu');
                        }
                    } catch (err) {
                        motionStatusEl.textContent = '‚úó';
                        motionStatusEl.classList.add('denied');
                    }
                } else {
                    motionStatusEl.textContent = '‚úì';
                    motionStatusEl.classList.add('granted');
                    addLog('‚úÖ Czujniki ruchu dostƒôpne');
                }
            }

            // Compass/Orientation
            if (typeof DeviceOrientationEvent !== 'undefined') {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const state = await DeviceOrientationEvent.requestPermission();
                        if (state === 'granted') {
                            compassStatusEl.textContent = '‚úì';
                            compassStatusEl.classList.add('granted');
                            addLog('‚úÖ Uzyskano uprawnienie kompasu');
                        }
                    } catch (err) {
                        compassStatusEl.textContent = '‚úó';
                        compassStatusEl.classList.add('denied');
                    }
                } else {
                    compassStatusEl.textContent = '‚úì';
                    compassStatusEl.classList.add('granted');
                    addLog('‚úÖ Kompas dostƒôpny');
                }
            }

            permissionsSection.style.display = 'none';
        }

        // Toggle monitoring
        function toggleMonitoring() {
            if (isMonitoring) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        }

        // Start monitoring
        function startMonitoring() {
            isMonitoring = true;
            btnStart.textContent = '‚èπ ZATRZYMAJ';
            btnStart.classList.add('active');
            statusText.textContent = 'AKTYWNY';
            addLog('üöÄ Monitoring uruchomiony');

            // GPS (always for initial position)
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    updateGPS,
                    handleGPSError,
                    { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                );
            }

            // Motion sensors
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleMotion);
            }

            // Orientation (compass)
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            // Request wake lock
            requestWakeLock();
        }

        // Stop monitoring
        function stopMonitoring() {
            isMonitoring = false;
            btnStart.textContent = '‚ñ∂ START MONITORINGU';
            btnStart.classList.remove('active');
            statusText.textContent = 'ZATRZYMANO';
            addLog('‚èπ Monitoring zatrzymany');

            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            window.removeEventListener('devicemotion', handleMotion);
            window.removeEventListener('deviceorientation', handleOrientation);
        }

        // Mark entry point (when entering building)
        function markEntryPoint() {
            if (lastPosition) {
                pdrState.entryPoint = { ...lastPosition };
                pdrState.stepCount = 0;
                pdrState.positionX = 0;
                pdrState.positionY = 0;
                pdrState.pathTrail = [];
                pdrState.currentFloor = 0;
                
                // Reset visualization
                updateIndoorMap();
                updateFloorIndicator(0);
                
                addLog('üö™ Punkt wej≈õcia zaznaczony!', false, 'info');
                addLog(`üìç GPS: ${lastPosition.lat.toFixed(6)}, ${lastPosition.lon.toFixed(6)}`, false, 'info');
            } else {
                addLog('‚ö†Ô∏è Brak pozycji GPS - poczekaj na sygna≈Ç', true);
            }
        }

        // Update GPS data
        function updateGPS(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const acc = position.coords.accuracy;
            const spd = position.coords.speed;

            document.getElementById('latitude').textContent = lat.toFixed(6) + '¬∞';
            document.getElementById('longitude').textContent = lon.toFixed(6) + '¬∞';
            document.getElementById('accuracy').textContent = acc.toFixed(1) + ' m';
            document.getElementById('speed').textContent = spd ? (spd * 3.6).toFixed(1) + ' km/h' : '0.0 km/h';

            lastPosition = {
                lat: lat,
                lon: lon,
                accuracy: acc,
                timestamp: new Date().toISOString()
            };
        }

        function handleGPSError(error) {
            addLog('‚ö†Ô∏è B≈ÇƒÖd GPS: ' + error.message, true);
            if (currentMode === 'outdoor') {
                addLog('üí° Prze≈ÇƒÖcz na tryb INDOOR (PDR)', false, 'info');
            }
        }

        // Handle motion (accelerometer + step detection)
        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity || event.acceleration;
            if (!acc) return;

            const x = acc.x || 0;
            const y = acc.y || 0;
            const z = acc.z || 0;

            // Update display
            document.getElementById('accelX').textContent = x.toFixed(2) + ' m/s¬≤';
            document.getElementById('accelY').textContent = y.toFixed(2) + ' m/s¬≤';
            document.getElementById('accelZ').textContent = z.toFixed(2) + ' m/s¬≤';

            const gForce = Math.sqrt(x*x + y*y + z*z) / 9.81;
            document.getElementById('gForce').textContent = gForce.toFixed(2) + ' G';

            const barWidth = Math.min(gForce / 5 * 100, 100);
            document.getElementById('gForceBar').style.width = barWidth + '%';

            // Step detection for indoor mode
            if (currentMode === 'indoor' && isMonitoring) {
                detectStep(x, y, z);
            }

            // Fall detection
            detectFall(gForce, x, y, z);
        }

        // Step detection algorithm
        function detectStep(x, y, z) {
            const magnitude = Math.sqrt(x*x + y*y + z*z);
            const now = Date.now();

            // Simple peak detection
            if (magnitude > pdrState.stepThreshold && 
                pdrState.lastAccelMagnitude < pdrState.stepThreshold &&
                !pdrState.stepCooldown) {
                
                pdrState.stepCooldown = true;
                pdrState.stepCount++;
                
                // Record step time for rate calculation
                pdrState.stepTimes.push(now);
                if (pdrState.stepTimes.length > 10) {
                    pdrState.stepTimes.shift();
                }

                // Calculate position change
                const headingRad = pdrState.currentHeading * (Math.PI / 180);
                pdrState.positionX += Math.sin(headingRad) * pdrState.stepLength;
                pdrState.positionY += Math.cos(headingRad) * pdrState.stepLength;

                // Add to trail
                pdrState.pathTrail.push({
                    x: pdrState.positionX,
                    y: pdrState.positionY
                });
                if (pdrState.pathTrail.length > 50) {
                    pdrState.pathTrail.shift();
                }

                // Update UI
                updatePedometerUI();
                updateIndoorMap();

                // Cooldown
                setTimeout(() => { pdrState.stepCooldown = false; }, 300);
            }

            pdrState.lastAccelMagnitude = magnitude;
        }

        // Update pedometer UI
        function updatePedometerUI() {
            const distance = pdrState.stepCount * pdrState.stepLength;
            document.getElementById('stepCount').textContent = pdrState.stepCount;
            document.getElementById('walkDistance').textContent = distance.toFixed(1) + ' m';

            // Calculate step rate
            if (pdrState.stepTimes.length >= 2) {
                const timeDiff = (pdrState.stepTimes[pdrState.stepTimes.length - 1] - pdrState.stepTimes[0]) / 1000;
                const rate = Math.round((pdrState.stepTimes.length - 1) / timeDiff * 60);
                document.getElementById('stepRate').textContent = rate + ' kr/min';
            }

            // Distance from entry
            const distFromEntry = Math.sqrt(
                pdrState.positionX * pdrState.positionX + 
                pdrState.positionY * pdrState.positionY
            );
            document.getElementById('distanceFromEntry').textContent = distFromEntry.toFixed(1) + ' m';
        }

        // Update indoor map visualization
        function updateIndoorMap() {
            const map = document.getElementById('indoorMap');
            const pos = document.getElementById('currentPosition');
            const arrow = document.getElementById('directionArrow');
            
            // Scale: 1 meter = 5 pixels, centered at 50%, 90%
            const scale = 5;
            const centerX = map.offsetWidth / 2;
            const centerY = map.offsetHeight * 0.9;
            
            const newX = centerX + pdrState.positionX * scale;
            const newY = centerY - pdrState.positionY * scale;
            
            // Clamp to map bounds
            const clampedX = Math.max(20, Math.min(map.offsetWidth - 20, newX));
            const clampedY = Math.max(20, Math.min(map.offsetHeight - 20, newY));
            
            pos.style.left = clampedX + 'px';
            pos.style.top = clampedY + 'px';
            
            // Direction arrow
            arrow.style.left = clampedX + 'px';
            arrow.style.top = (clampedY - 30) + 'px';
            arrow.style.transform = `rotate(${pdrState.currentHeading}deg)`;

            // Update direction text
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const idx = Math.round(pdrState.currentHeading / 45) % 8;
            document.getElementById('currentDirection').textContent = 
                directions[idx] + ' ' + Math.round(pdrState.currentHeading) + '¬∞';

            // Draw trail
            const existingTrails = map.querySelectorAll('.path-trail');
            existingTrails.forEach(t => t.remove());

            pdrState.pathTrail.forEach((point, i) => {
                const trail = document.createElement('div');
                trail.className = 'path-trail';
                trail.style.left = (centerX + point.x * scale) + 'px';
                trail.style.top = (centerY - point.y * scale) + 'px';
                trail.style.opacity = 0.2 + (i / pdrState.pathTrail.length) * 0.6;
                map.appendChild(trail);
            });
        }

        // Handle orientation (compass)
        function handleOrientation(event) {
            // Alpha is the compass heading (0-360)
            let heading = event.alpha || 0;
            
            // On iOS, we need to use webkitCompassHeading if available
            if (event.webkitCompassHeading !== undefined) {
                heading = event.webkitCompassHeading;
            } else if (event.alpha !== null) {
                // Android: alpha is relative to device orientation
                heading = 360 - event.alpha;
            }

            pdrState.currentHeading = heading;

            // Update compass display
            document.getElementById('heading').textContent = Math.round(heading) + '¬∞';
            // Needle points to NORTH - rotate opposite to heading
            document.getElementById('compassNeedle').style.transform = 
                `translate(-50%, -50%) rotate(${-heading}deg)`;

            // Gyroscope display
            document.getElementById('alpha').textContent = (event.alpha || 0).toFixed(0) + '¬∞';
            document.getElementById('beta').textContent = (event.beta || 0).toFixed(0) + '¬∞';
            document.getElementById('gamma').textContent = (event.gamma || 0).toFixed(0) + '¬∞';

            // Floor detection using beta (tilt) - rough estimation
            // In real app, would use barometer API if available
            detectFloorChange(event.beta);

            if (currentMode === 'indoor' && isMonitoring) {
                updateIndoorMap();
            }
        }

        // Floor detection (simulated using orientation changes)
        // In production, use Barometer API: navigator.sensor.Barometer
        function detectFloorChange(beta) {
            // Simulate floor detection based on sustained tilt
            // Real implementation would use pressure sensor
            const pressure = 1013.25; // Simulated sea level pressure
            document.getElementById('pressure').textContent = pressure.toFixed(1) + ' hPa';
            document.getElementById('altitudeChange').textContent = 
                (pdrState.currentFloor * 3).toFixed(1) + ' m';
        }

        // Update floor indicator
        function updateFloorIndicator(floor) {
            pdrState.currentFloor = floor;
            const floorLevels = document.querySelectorAll('.floor-level');
            floorLevels.forEach(el => {
                el.classList.remove('current');
                if (parseInt(el.dataset.floor) === floor) {
                    el.classList.add('current');
                }
            });
            document.getElementById('currentFloor').textContent = 
                floor >= 0 ? 'P' + floor : floor.toString();
        }

        // Fall detection
        function detectFall(gForce, x, y, z) {
            const fallStatus = document.getElementById('fallStatus');
            const personIcon = document.getElementById('personIcon');
            const accelCard = document.getElementById('accelCard');
            const fallCard = document.getElementById('fallCard');

            const isFreefall = gForce < 0.3;
            const isImpact = gForce > fallThreshold;

            if ((isFreefall || isImpact) && !impactCooldown) {
                impactCooldown = true;
                
                fallStatus.textContent = '‚ö†Ô∏è UPADEK!';
                fallStatus.style.color = '#dc3545';
                personIcon.classList.add('falling');
                accelCard.classList.add('alert');
                fallCard.classList.add('alert');
                statusIndicator.classList.add('danger');
                statusText.textContent = 'UPADEK!';

                addLog(`üö® WYKRYTO UPADEK! G-Force: ${gForce.toFixed(2)}G`, true);

                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }

                showFallAlert();

                setTimeout(() => {
                    personIcon.classList.remove('falling');
                    impactCooldown = false;
                }, 3000);
            } else if (!impactCooldown) {
                fallStatus.textContent = 'NORMA ‚úì';
                fallStatus.style.color = '#28a745';
                accelCard.classList.remove('alert');
                fallCard.classList.remove('alert');
            }
        }

        // Show fall alert
        function showFallAlert() {
            alertModal.classList.add('show');
            alertCountdown = 10;
            document.getElementById('alertCountdown').textContent = alertCountdown;

            countdownInterval = setInterval(() => {
                alertCountdown--;
                document.getElementById('alertCountdown').textContent = alertCountdown;
                if (alertCountdown <= 0) {
                    clearInterval(countdownInterval);
                    triggerEmergency();
                }
            }, 1000);
        }

        // Cancel alert
        function cancelAlert() {
            alertModal.classList.remove('show');
            clearInterval(countdownInterval);
            statusIndicator.classList.remove('danger');
            statusText.textContent = 'AKTYWNY';
            addLog('‚úÖ Alarm anulowany przez u≈ºytkownika');
            if (navigator.vibrate) navigator.vibrate(0);
        }

        // Trigger SOS
        function triggerSOS() {
            addLog('üÜò SOS AKTYWOWANE RƒòCZNIE!', true);
            triggerEmergency();
        }

        // Trigger emergency
        function triggerEmergency() {
            alertModal.classList.remove('show');
            clearInterval(countdownInterval);

            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500, 200, 500]);
            }

            addLog('üö® WEZWANIE POMOCY!', true);

            let emergencyMsg = 'üö® ALARM STRA≈ªAKA!\n';
            emergencyMsg += `Czas: ${new Date().toLocaleString()}\n`;
            emergencyMsg += `Tryb: ${currentMode === 'indoor' ? 'INDOOR (PDR)' : 'OUTDOOR (GPS)'}\n`;
            
            if (currentMode === 'indoor' && pdrState.entryPoint) {
                emergencyMsg += `\nüìç PUNKT WEJ≈öCIA:\n`;
                emergencyMsg += `${pdrState.entryPoint.lat.toFixed(6)}, ${pdrState.entryPoint.lon.toFixed(6)}\n`;
                emergencyMsg += `Google Maps: https://maps.google.com/?q=${pdrState.entryPoint.lat},${pdrState.entryPoint.lon}\n`;
                emergencyMsg += `\nüè¢ POZYCJA WEWNƒòTRZNA:\n`;
                emergencyMsg += `Piƒôtro: ${pdrState.currentFloor >= 0 ? 'P' + pdrState.currentFloor : pdrState.currentFloor}\n`;
                emergencyMsg += `Od wej≈õcia: ${Math.sqrt(pdrState.positionX**2 + pdrState.positionY**2).toFixed(1)}m\n`;
                emergencyMsg += `Kierunek: ${Math.round(pdrState.currentHeading)}¬∞\n`;
                emergencyMsg += `Kroki: ${pdrState.stepCount}`;
            } else if (lastPosition) {
                emergencyMsg += `\nWsp√≥≈Çrzƒôdne: ${lastPosition.lat.toFixed(6)}, ${lastPosition.lon.toFixed(6)}\n`;
                emergencyMsg += `Google Maps: https://maps.google.com/?q=${lastPosition.lat},${lastPosition.lon}`;
            }

            alert(emergencyMsg);

            console.log('EMERGENCY DATA:', {
                timestamp: new Date().toISOString(),
                mode: currentMode,
                gpsPosition: lastPosition,
                indoorPosition: currentMode === 'indoor' ? {
                    entryPoint: pdrState.entryPoint,
                    relativeX: pdrState.positionX,
                    relativeY: pdrState.positionY,
                    floor: pdrState.currentFloor,
                    heading: pdrState.currentHeading,
                    steps: pdrState.stepCount
                } : null,
                type: 'FALL_DETECTED'
            });

            statusIndicator.classList.add('danger');
            statusText.textContent = 'SOS AKTYWNY';
        }

        // Reset alerts
        function resetAlerts() {
            cancelAlert();
            document.querySelectorAll('.sensor-card').forEach(card => {
                card.classList.remove('alert');
            });
            document.getElementById('fallStatus').textContent = 'NORMA ‚úì';
            document.getElementById('fallStatus').style.color = '#28a745';
            statusIndicator.classList.remove('danger', 'warning');
            
            // Reset PDR
            pdrState.stepCount = 0;
            pdrState.positionX = 0;
            pdrState.positionY = 0;
            pdrState.pathTrail = [];
            updatePedometerUI();
            updateIndoorMap();
            
            if (isMonitoring) {
                statusText.textContent = 'AKTYWNY';
            }
            addLog('üîÑ System zresetowany');
        }

        // Add log entry
        function addLog(message, isDanger = false, type = null) {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            let className = 'log-entry';
            if (isDanger) className += ' danger';
            if (type === 'info') className += ' info';
            entry.className = className;
            entry.innerHTML = `<span class="log-time">${time}</span>${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);

            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Wake lock
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    await navigator.wakeLock.request('screen');
                    addLog('üì± Ekran zablokowany przed u≈õpieniem');
                } catch (err) {
                    console.log('Wake Lock error:', err);
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üî• FireGuard v2.0 za≈Çadowano');
            addLog('üìç Obs≈Çuga GPS + PDR Indoor', false, 'info');
            
            if (!navigator.geolocation) {
                addLog('‚ö†Ô∏è Geolocation API nie jest obs≈Çugiwane', true);
            }
            if (!window.DeviceMotionEvent) {
                addLog('‚ö†Ô∏è DeviceMotion API nie jest obs≈Çugiwane', true);
            }
            if (!window.DeviceOrientationEvent) {
                addLog('‚ö†Ô∏è DeviceOrientation API nie jest obs≈Çugiwane', true);
            }
        });
    </script>
</body>
</html>
